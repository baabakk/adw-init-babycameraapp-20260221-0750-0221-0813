{
  "n": 1,
  "tool": "writeFile",
  "input": {
    "path": "baby-monitor.html",
    "content": "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Baby Monitor - P2P Browser App</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        }\n\n        .container {\n            background: white;\n            border-radius: 20px;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n            max-width: 1200px;\n            width: 100%;\n            padding: 40px;\n            min-height: 600px;\n        }\n\n        header {\n            text-align: center;\n            margin-bottom: 30px;\n        }\n\n        h1 {\n            color: #333;\n            font-size: 2.5em;\n            margin-bottom: 10px;\n        }\n\n        .subtitle {\n            color: #666;\n            font-size: 1.1em;\n        }\n\n        .mode-selector {\n            display: flex;\n            gap: 20px;\n            justify-content: center;\n            margin-bottom: 30px;\n        }\n\n        .mode-btn {\n            padding: 15px 40px;\n            font-size: 1.1em;\n            border: 2px solid #667eea;\n            background: white;\n            color: #667eea;\n            border-radius: 10px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            font-weight: 600;\n        }\n\n        .mode-btn:hover {\n            background: #667eea;\n            color: white;\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);\n        }\n\n        .mode-btn.active {\n            background: #667eea;\n            color: white;\n        }\n\n        .mode-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n        }\n\n        .status-bar {\n            background: #f5f5f5;\n            padding: 15px;\n            border-radius: 10px;\n            margin-bottom: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            flex-wrap: wrap;\n            gap: 10px;\n        }\n\n        .status-indicator {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .status-dot {\n            width: 12px;\n            height: 12px;\n            border-radius: 50%;\n            background: #ccc;\n        }\n\n        .status-dot.connected {\n            background: #4caf50;\n            animation: pulse 2s infinite;\n        }\n\n        .status-dot.connecting {\n            background: #ff9800;\n            animation: pulse 1s infinite;\n        }\n\n        .status-dot.disconnected {\n            background: #f44336;\n        }\n\n        @keyframes pulse {\n            0%, 100% { opacity: 1; }\n            50% { opacity: 0.5; }\n        }\n\n        .cry-indicator {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            padding: 10px 20px;\n            background: #fff3cd;\n            border: 2px solid #ffc107;\n            border-radius: 8px;\n            font-weight: 600;\n            color: #856404;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .cry-indicator.active {\n            opacity: 1;\n            animation: shake 0.5s;\n        }\n\n        @keyframes shake {\n            0%, 100% { transform: translateX(0); }\n            25% { transform: translateX(-5px); }\n            75% { transform: translateX(5px); }\n        }\n\n        .cry-icon {\n            font-size: 1.5em;\n        }\n\n        .content-area {\n            min-height: 400px;\n        }\n\n        .idle-screen {\n            text-align: center;\n            padding: 60px 20px;\n        }\n\n        .idle-screen h2 {\n            color: #333;\n            margin-bottom: 20px;\n        }\n\n        .idle-screen p {\n            color: #666;\n            font-size: 1.1em;\n            line-height: 1.6;\n            max-width: 600px;\n            margin: 0 auto;\n        }\n\n        .video-container {\n            position: relative;\n            background: #000;\n            border-radius: 10px;\n            overflow: hidden;\n            margin-bottom: 20px;\n        }\n\n        video {\n            width: 100%;\n            height: auto;\n            display: block;\n            max-height: 500px;\n            object-fit: contain;\n        }\n\n        .connection-panel {\n            background: #f9f9f9;\n            padding: 20px;\n            border-radius: 10px;\n            margin-bottom: 20px;\n        }\n\n        .connection-panel h3 {\n            color: #333;\n            margin-bottom: 15px;\n        }\n\n        .connection-step {\n            margin-bottom: 20px;\n        }\n\n        .connection-step label {\n            display: block;\n            color: #555;\n            margin-bottom: 8px;\n            font-weight: 600;\n        }\n\n        .code-display {\n            background: white;\n            border: 2px solid #ddd;\n            border-radius: 8px;\n            padding: 15px;\n            font-family: 'Courier New', monospace;\n            font-size: 0.9em;\n            word-break: break-all;\n            max-height: 150px;\n            overflow-y: auto;\n            margin-bottom: 10px;\n        }\n\n        .code-input {\n            width: 100%;\n            padding: 15px;\n            border: 2px solid #ddd;\n            border-radius: 8px;\n            font-family: 'Courier New', monospace;\n            font-size: 0.9em;\n            resize: vertical;\n            min-height: 100px;\n        }\n\n        .code-input:focus {\n            outline: none;\n            border-color: #667eea;\n        }\n\n        .btn {\n            padding: 12px 30px;\n            font-size: 1em;\n            border: none;\n            border-radius: 8px;\n            cursor: pointer;\n            font-weight: 600;\n            transition: all 0.3s ease;\n        }\n\n        .btn-primary {\n            background: #667eea;\n            color: white;\n        }\n\n        .btn-primary:hover {\n            background: #5568d3;\n            transform: translateY(-2px);\n            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);\n        }\n\n        .btn-secondary {\n            background: #6c757d;\n            color: white;\n        }\n\n        .btn-secondary:hover {\n            background: #5a6268;\n        }\n\n        .btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .btn-group {\n            display: flex;\n            gap: 10px;\n            flex-wrap: wrap;\n        }\n\n        .alert {\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            display: none;\n        }\n\n        .alert.show {\n            display: block;\n        }\n\n        .alert-error {\n            background: #f8d7da;\n            border: 1px solid #f5c6cb;\n            color: #721c24;\n        }\n\n        .alert-warning {\n            background: #fff3cd;\n            border: 1px solid #ffeaa7;\n            color: #856404;\n        }\n\n        .alert-info {\n            background: #d1ecf1;\n            border: 1px solid #bee5eb;\n            color: #0c5460;\n        }\n\n        .alert-success {\n            background: #d4edda;\n            border: 1px solid #c3e6cb;\n            color: #155724;\n        }\n\n        .sensitivity-control {\n            margin-top: 20px;\n            padding: 15px;\n            background: #f0f0f0;\n            border-radius: 8px;\n        }\n\n        .sensitivity-control label {\n            display: block;\n            color: #333;\n            margin-bottom: 10px;\n            font-weight: 600;\n        }\n\n        .slider-container {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n        .slider {\n            flex: 1;\n            height: 6px;\n            border-radius: 3px;\n            background: #ddd;\n            outline: none;\n            -webkit-appearance: none;\n        }\n\n        .slider::-webkit-slider-thumb {\n            -webkit-appearance: none;\n            appearance: none;\n            width: 20px;\n            height: 20px;\n            border-radius: 50%;\n            background: #667eea;\n            cursor: pointer;\n        }\n\n        .slider::-moz-range-thumb {\n            width: 20px;\n            height: 20px;\n            border-radius: 50%;\n            background: #667eea;\n            cursor: pointer;\n            border: none;\n        }\n\n        .slider-value {\n            min-width: 40px;\n            text-align: center;\n            font-weight: 600;\n            color: #667eea;\n        }\n\n        .instructions {\n            background: #e7f3ff;\n            border-left: 4px solid #2196f3;\n            padding: 15px;\n            margin-top: 20px;\n            border-radius: 4px;\n        }\n\n        .instructions h4 {\n            color: #1976d2;\n            margin-bottom: 10px;\n        }\n\n        .instructions ol {\n            margin-left: 20px;\n            color: #555;\n        }\n\n        .instructions li {\n            margin-bottom: 8px;\n            line-height: 1.5;\n        }\n\n        .hidden {\n            display: none !important;\n        }\n\n        @media (max-width: 768px) {\n            .container {\n                padding: 20px;\n            }\n\n            h1 {\n                font-size: 1.8em;\n            }\n\n            .mode-selector {\n                flex-direction: column;\n            }\n\n            .mode-btn {\n                width: 100%;\n            }\n\n            .status-bar {\n                flex-direction: column;\n                align-items: flex-start;\n            }\n        }\n\n        .browser-warning {\n            background: #fff3cd;\n            border: 2px solid #ffc107;\n            padding: 20px;\n            border-radius: 10px;\n            margin-bottom: 20px;\n            text-align: center;\n        }\n\n        .browser-warning h3 {\n            color: #856404;\n            margin-bottom: 10px;\n        }\n\n        .browser-warning p {\n            color: #856404;\n        }\n\n        .loading {\n            text-align: center;\n            padding: 20px;\n            color: #666;\n        }\n\n        .spinner {\n            border: 4px solid #f3f3f3;\n            border-top: 4px solid #667eea;\n            border-radius: 50%;\n            width: 40px;\n            height: 40px;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 15px;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <header>\n            <h1>üë∂ Baby Monitor</h1>\n            <p class=\"subtitle\">Peer-to-Peer Browser Baby Monitoring</p>\n        </header>\n\n        <div id=\"browserWarning\" class=\"browser-warning hidden\">\n            <h3>‚ö†Ô∏è Browser Compatibility Issue</h3>\n            <p id=\"browserWarningText\"></p>\n        </div>\n\n        <div class=\"mode-selector\">\n            <button class=\"mode-btn\" id=\"senderModeBtn\" onclick=\"app.switchMode('sender')\">\n                üìπ Camera Mode (Sender)\n            </button>\n            <button class=\"mode-btn\" id=\"viewerModeBtn\" onclick=\"app.switchMode('viewer')\">\n                üëÄ Monitor Mode (Viewer)\n            </button>\n        </div>\n\n        <div class=\"status-bar\">\n            <div class=\"status-indicator\">\n                <div class=\"status-dot\" id=\"statusDot\"></div>\n                <span id=\"statusText\">Idle</span>\n            </div>\n            <div class=\"cry-indicator\" id=\"cryIndicator\">\n                <span class=\"cry-icon\">üò¢</span>\n                <span>Crying Detected!</span>\n            </div>\n        </div>\n\n        <div id=\"alertContainer\"></div>\n\n        <div class=\"content-area\">\n            <!-- Idle Screen -->\n            <div id=\"idleScreen\" class=\"idle-screen\">\n                <h2>Welcome to Baby Monitor</h2>\n                <p>\n                    This is a peer-to-peer baby monitoring application that works entirely in your browser.\n                    No servers, no installation required.\n                </p>\n                <p style=\"margin-top: 20px;\">\n                    <strong>Choose a mode above to get started:</strong><br>\n                    üìπ <strong>Camera Mode</strong> - Use this device to stream video/audio from the baby's room<br>\n                    üëÄ <strong>Monitor Mode</strong> - Use this device to watch the stream and receive cry alerts\n                </p>\n            </div>\n\n            <!-- Sender Screen -->\n            <div id=\"senderScreen\" class=\"hidden\">\n                <div class=\"video-container\">\n                    <video id=\"localVideo\" autoplay muted playsinline></video>\n                </div>\n\n                <div class=\"connection-panel\">\n                    <h3>üì° Connection Setup</h3>\n                    \n                    <div class=\"connection-step\">\n                        <label>Step 1: Your Connection Code (Share this with the viewer)</label>\n                        <div class=\"code-display\" id=\"offerCode\">Initializing...</div>\n                        <button class=\"btn btn-primary\" onclick=\"app.copyOffer()\">üìã Copy Code</button>\n                    </div>\n\n                    <div class=\"connection-step\">\n                        <label>Step 2: Paste the Answer Code from Viewer</label>\n                        <textarea class=\"code-input\" id=\"answerInput\" placeholder=\"Paste the answer code from the viewer here...\"></textarea>\n                        <div class=\"btn-group\">\n                            <button class=\"btn btn-primary\" onclick=\"app.setAnswer()\">‚úÖ Connect</button>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"sensitivity-control\">\n                    <label>üîä Cry Detection Sensitivity</label>\n                    <div class=\"slider-container\">\n                        <span>Low</span>\n                        <input type=\"range\" min=\"1\" max=\"10\" value=\"7\" class=\"slider\" id=\"senderSensitivity\" onchange=\"app.updateSensitivity(this.value)\">\n                        <span>High</span>\n                        <span class=\"slider-value\" id=\"senderSensitivityValue\">7</span>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Viewer Screen -->\n            <div id=\"viewerScreen\" class=\"hidden\">\n                <div class=\"video-container hidden\" id=\"remoteVideoContainer\">\n                    <video id=\"remoteVideo\" autoplay playsinline controls></video>\n                </div>\n\n                <div class=\"loading\" id=\"viewerLoading\">\n                    <div class=\"spinner\"></div>\n                    <p>Waiting for connection...</p>\n                </div>\n\n                <div class=\"connection-panel\">\n                    <h3>üì° Connection Setup</h3>\n                    \n                    <div class=\"connection-step\">\n                        <label>Step 1: Paste the Offer Code from Camera</label>\n                        <textarea class=\"code-input\" id=\"offerInput\" placeholder=\"Paste the offer code from the camera here...\"></textarea>\n                        <button class=\"btn btn-primary\" onclick=\"app.processOffer()\">üì• Process Offer</button>\n                    </div>\n\n                    <div class=\"connection-step\">\n                        <label>Step 2: Your Answer Code (Share this back to the camera)</label>\n                        <div class=\"code-display\" id=\"answerCode\">Waiting for offer...</div>\n                        <button class=\"btn btn-primary\" id=\"copyAnswerBtn\" onclick=\"app.copyAnswer()\" disabled>üìã Copy Answer</button>\n                    </div>\n                </div>\n\n                <div class=\"sensitivity-control\">\n                    <label>üîä Cry Detection Sensitivity</label>\n                    <div class=\"slider-container\">\n                        <span>Low</span>\n                        <input type=\"range\" min=\"1\" max=\"10\" value=\"7\" class=\"slider\" id=\"viewerSensitivity\" onchange=\"app.updateSensitivity(this.value)\">\n                        <span>High</span>\n                        <span class=\"slider-value\" id=\"viewerSensitivityValue\">7</span>\n                    </div>\n                </div>\n\n                <div class=\"instructions\">\n                    <h4>üì± Notification Setup</h4>\n                    <ol>\n                        <li>Make sure you've granted notification permissions when prompted</li>\n                        <li>Keep this browser window open (you can minimize or switch tabs)</li>\n                        <li>You'll receive notifications when crying is detected, even when this tab is in the background</li>\n                    </ol>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Main Application State and Logic\n        const app = {\n            mode: 'idle',\n            peerConnection: null,\n            localStream: null,\n            remoteStream: null,\n            audioContext: null,\n            analyser: null,\n            sensitivity: 7,\n            cryDetectionActive: false,\n            lastCryTime: 0,\n            notificationPermission: false,\n            connectionState: 'idle',\n\n            // Initialize the application\n            init() {\n                this.checkBrowserSupport();\n                this.loadSensitivity();\n                this.updateUI();\n            },\n\n            // Check browser compatibility\n            checkBrowserSupport() {\n                const warnings = [];\n\n                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\n                    warnings.push('Your browser does not support camera/microphone access (getUserMedia).');\n                }\n\n                if (!window.RTCPeerConnection) {\n                    warnings.push('Your browser does not support WebRTC peer connections.');\n                }\n\n                if (!window.AudioContext && !window.webkitAudioContext) {\n                    warnings.push('Your browser does not support Web Audio API for cry detection.');\n                }\n\n                if (warnings.length > 0) {\n                    const warningEl = document.getElementById('browserWarning');\n                    const warningText = document.getElementById('browserWarningText');\n                    warningText.innerHTML = warnings.join('<br>') + '<br><br>Please use Chrome 80+, Firefox 75+, Safari 14+, or Edge 80+.';\n                    warningEl.classList.remove('hidden');\n                }\n            },\n\n            // Switch between modes\n            async switchMode(newMode) {\n                if (this.mode === newMode) return;\n\n                // Cleanup previous mode\n                this.cleanup();\n\n                this.mode = newMode;\n                this.updateUI();\n\n                if (newMode === 'sender') {\n                    await this.initSenderMode();\n                } else if (newMode === 'viewer') {\n                    await this.initViewerMode();\n                }\n            },\n\n            // Initialize sender mode\n            async initSenderMode() {\n                try {\n                    this.updateStatus('connecting', 'Requesting camera access...');\n\n                    // Request camera and microphone access\n                    this.localStream = await navigator.mediaDevices.getUserMedia({\n                        video: true,\n                        audio: true\n                    });\n\n                    // Display local video\n                    const localVideo = document.getElementById('localVideo');\n                    localVideo.srcObject = this.localStream;\n\n                    // Initialize peer connection\n                    this.initPeerConnection();\n\n                    // Add tracks to peer connection\n                    this.localStream.getTracks().forEach(track => {\n                        this.peerConnection.addTrack(track, this.localStream);\n                    });\n\n                    // Create offer\n                    const offer = await this.peerConnection.createOffer();\n                    await this.peerConnection.setLocalDescription(offer);\n\n                    // Display offer code\n                    const offerCode = btoa(JSON.stringify(offer));\n                    document.getElementById('offerCode').textContent = offerCode;\n\n                    // Initialize cry detection on sender\n                    this.initCryDetection(this.localStream);\n\n                    this.updateStatus('disconnected', 'Waiting for viewer to connect...');\n                    this.showAlert('Camera access granted. Share your connection code with the viewer.', 'success');\n\n                } catch (error) {\n                    console.error('Error initializing sender mode:', error);\n                    this.showAlert('Failed to access camera/microphone: ' + error.message, 'error');\n                    this.updateStatus('disconnected', 'Camera access denied');\n                }\n            },\n\n            // Initialize viewer mode\n            async initViewerMode() {\n                this.updateStatus('disconnected', 'Waiting for connection...');\n\n                // Request notification permission\n                if ('Notification' in window && Notification.permission === 'default') {\n                    try {\n                        const permission = await Notification.requestPermission();\n                        this.notificationPermission = permission === 'granted';\n                        \n                        if (this.notificationPermission) {\n                            this.showAlert('Notification permission granted. You will receive alerts when crying is detected.', 'success');\n                        } else {\n                            this.showAlert('Notification permission denied. You must keep this tab visible to see cry alerts.', 'warning');\n                        }\n                    } catch (error) {\n                        console.error('Error requesting notification permission:', error);\n                    }\n                } else if ('Notification' in window && Notification.permission === 'granted') {\n                    this.notificationPermission = true;\n                }\n\n                // Initialize peer connection\n                this.initPeerConnection();\n            },\n\n            // Initialize WebRTC peer connection\n            initPeerConnection() {\n                // No STUN/TURN servers - local network only per ADR-004\n                const configuration = {\n                    iceServers: []\n                };\n\n                this.peerConnection = new RTCPeerConnection(configuration);\n\n                // Handle ICE candidates\n                this.peerConnection.onicecandidate = (event) => {\n                    // ICE candidates are included in the SDP, no separate exchange needed\n                };\n\n                // Handle connection state changes\n                this.peerConnection.onconnectionstatechange = () => {\n                    const state = this.peerConnection.connectionState;\n                    console.log('Connection state:', state);\n\n                    if (state === 'connected') {\n                        this.updateStatus('connected', 'Connected');\n                        this.showAlert('Peer connection established successfully!', 'success');\n                    } else if (state === 'disconnected' || state === 'failed') {\n                        this.updateStatus('disconnected', 'Disconnected');\n                        \n                        if (state === 'failed') {\n                            this.showAlert(\n                                'Connection failed. This may be due to NAT/firewall restrictions. ' +\n                                'Make sure both devices are on the same local network (same WiFi). ' +\n                                'If the problem persists, try restarting both browser instances.',\n                                'error'\n                            );\n                        }\n                    } else if (state === 'connecting') {\n                        this.updateStatus('connecting', 'Connecting...');\n                    }\n                };\n\n                // Handle incoming tracks (viewer side)\n                this.peerConnection.ontrack = (event) => {\n                    console.log('Received remote track:', event.track.kind);\n                    \n                    if (!this.remoteStream) {\n                        this.remoteStream = new MediaStream();\n                        const remoteVideo = document.getElementById('remoteVideo');\n                        remoteVideo.srcObject = this.remoteStream;\n                        \n                        // Show video container, hide loading\n                        document.getElementById('remoteVideoContainer').classList.remove('hidden');\n                        document.getElementById('viewerLoading').classList.add('hidden');\n                    }\n\n                    this.remoteStream.addTrack(event.track);\n\n                    // Initialize cry detection on viewer when audio track received\n                    if (event.track.kind === 'audio' && !this.cryDetectionActive) {\n                        this.initCryDetection(this.remoteStream);\n                    }\n                };\n\n                // Handle ICE connection state\n                this.peerConnection.oniceconnectionstatechange = () => {\n                    console.log('ICE connection state:', this.peerConnection.iceConnectionState);\n                };\n            },\n\n            // Process offer (viewer side)\n            async processOffer() {\n                const offerInput = document.getElementById('offerInput').value.trim();\n                \n                if (!offerInput) {\n                    this.showAlert('Please paste the offer code from the camera.', 'warning');\n                    return;\n                }\n\n                try {\n                    const offer = JSON.parse(atob(offerInput));\n                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));\n\n                    const answer = await this.peerConnection.createAnswer();\n                    await this.peerConnection.setLocalDescription(answer);\n\n                    const answerCode = btoa(JSON.stringify(answer));\n                    document.getElementById('answerCode').textContent = answerCode;\n                    document.getElementById('copyAnswerBtn').disabled = false;\n\n                    this.showAlert('Offer processed. Copy the answer code and send it back to the camera.', 'info');\n\n                } catch (error) {\n                    console.error('Error processing offer:', error);\n                    this.showAlert('Invalid offer code. Please check and try again.', 'error');\n                }\n            },\n\n            // Set answer (sender side)\n            async setAnswer() {\n                const answerInput = document.getElementById('answerInput').value.trim();\n                \n                if (!answerInput) {\n                    this.showAlert('Please paste the answer code from the viewer.', 'warning');\n                    return;\n                }\n\n                try {\n                    const answer = JSON.parse(atob(answerInput));\n                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));\n\n                    this.showAlert('Connection established! Waiting for peer confirmation...', 'success');\n\n                } catch (error) {\n                    console.error('Error setting answer:', error);\n                    this.showAlert('Invalid answer code. Please check and try again.', 'error');\n                }\n            },\n\n            // Copy offer code\n            copyOffer() {\n                const offerCode = document.getElementById('offerCode').textContent;\n                this.copyToClipboard(offerCode, 'Offer code copied to clipboard!');\n            },\n\n            // Copy answer code\n            copyAnswer() {\n                const answerCode = document.getElementById('answerCode').textContent;\n                this.copyToClipboard(answerCode, 'Answer code copied to clipboard!');\n            },\n\n            // Copy to clipboard helper\n            copyToClipboard(text, successMessage) {\n                if (navigator.clipboard && navigator.clipboard.writeText) {\n                    navigator.clipboard.writeText(text).then(() => {\n                        this.showAlert(successMessage, 'success');\n                    }).catch(err => {\n                        console.error('Failed to copy:', err);\n                        this.fallbackCopy(text, successMessage);\n                    });\n                } else {\n                    this.fallbackCopy(text, successMessage);\n                }\n            },\n\n            // Fallback copy method\n            fallbackCopy(text, successMessage) {\n                const textarea = document.createElement('textarea');\n                textarea.value = text;\n                textarea.style.position = 'fixed';\n                textarea.style.opacity = '0';\n                document.body.appendChild(textarea);\n                textarea.select();\n                \n                try {\n                    document.execCommand('copy');\n                    this.showAlert(successMessage, 'success');\n                } catch (err) {\n                    console.error('Fallback copy failed:', err);\n                    this.showAlert('Failed to copy. Please select and copy manually.', 'warning');\n                }\n                \n                document.body.removeChild(textarea);\n            },\n\n            // Initialize cry detection\n            initCryDetection(stream) {\n                try {\n                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;\n                    this.audioContext = new AudioContextClass();\n                    \n                    const source = this.audioContext.createMediaStreamSource(stream);\n                    this.analyser = this.audioContext.createAnalyser();\n                    \n                    this.analyser.fftSize = 2048;\n                    this.analyser.smoothingTimeConstant = 0.8;\n                    \n                    source.connect(this.analyser);\n                    \n                    this.cryDetectionActive = true;\n                    this.detectCrying();\n\n                    console.log('Cry detection initialized');\n\n                } catch (error) {\n                    console.error('Error initializing cry detection:', error);\n                }\n            },\n\n            // Cry detection algorithm\n            detectCrying() {\n                if (!this.cryDetectionActive || !this.analyser) return;\n\n                const bufferLength = this.analyser.frequencyBinCount;\n                const dataArray = new Uint8Array(bufferLength);\n                this.analyser.getByteFrequencyData(dataArray);\n\n                // Calculate sample rate and frequency resolution\n                const sampleRate = this.audioContext.sampleRate;\n                const frequencyResolution = sampleRate / this.analyser.fftSize;\n\n                // Baby crying typically in 300-600Hz range\n                const minFreq = 300;\n                const maxFreq = 600;\n                const minBin = Math.floor(minFreq / frequencyResolution);\n                const maxBin = Math.floor(maxFreq / frequencyResolution);\n\n                // Calculate average amplitude in crying frequency range\n                let sum = 0;\n                let count = 0;\n                for (let i = minBin; i <= maxBin && i < bufferLength; i++) {\n                    sum += dataArray[i];\n                    count++;\n                }\n                const avgAmplitude = count > 0 ? sum / count : 0;\n\n                // Calculate overall amplitude\n                const overallSum = dataArray.reduce((a, b) => a + b, 0);\n                const overallAvg = overallSum / bufferLength;\n\n                // Sensitivity-based threshold (1-10 scale, higher = more sensitive)\n                // Base threshold at 100, reduced by sensitivity\n                const baseThreshold = 100;\n                const sensitivityFactor = (11 - this.sensitivity) / 10; // 1.0 to 0.1\n                const threshold = baseThreshold * sensitivityFactor;\n\n                // Detect crying if amplitude in target range exceeds threshold\n                // and is significantly higher than overall average\n                const isCrying = avgAmplitude > threshold && avgAmplitude > overallAvg * 1.5;\n\n                if (isCrying) {\n                    this.onCryDetected();\n                }\n\n                // Continue detection loop\n                requestAnimationFrame(() => this.detectCrying());\n            },\n\n            // Handle cry detection event\n            onCryDetected() {\n                const now = Date.now();\n                \n                // Debounce: only trigger once every 5 seconds\n                if (now - this.lastCryTime < 5000) {\n                    return;\n                }\n\n                this.lastCryTime = now;\n\n                console.log('Crying detected!');\n\n                // Show visual indicator\n                const indicator = document.getElementById('cryIndicator');\n                indicator.classList.add('active');\n                setTimeout(() => {\n                    indicator.classList.remove('active');\n                }, 3000);\n\n                // Send notification if in viewer mode\n                if (this.mode === 'viewer' && this.notificationPermission) {\n                    this.sendNotification();\n                }\n            },\n\n            // Send browser notification\n            sendNotification() {\n                if ('Notification' in window && Notification.permission === 'granted') {\n                    try {\n                        const notification = new Notification('üë∂ Baby Crying Detected!', {\n                            body: 'Your baby may need attention.',\n                            icon: 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\"75\" font-size=\"75\">üë∂</text></svg>',\n                            tag: 'baby-cry',\n                            requireInteraction: false,\n                            silent: false\n                        });\n\n                        notification.onclick = () => {\n                            window.focus();\n                            notification.close();\n                        };\n\n                        // Auto-close after 10 seconds\n                        setTimeout(() => notification.close(), 10000);\n\n                    } catch (error) {\n                        console.error('Error sending notification:', error);\n                    }\n                }\n            },\n\n            // Update sensitivity\n            updateSensitivity(value) {\n                this.sensitivity = parseInt(value);\n                document.getElementById('senderSensitivityValue').textContent = value;\n                document.getElementById('viewerSensitivityValue').textContent = value;\n                \n                // Save to localStorage\n                try {\n                    localStorage.setItem('babyCrySensitivity', value);\n                } catch (e) {\n                    console.error('Failed to save sensitivity:', e);\n                }\n            },\n\n            // Load sensitivity from localStorage\n            loadSensitivity() {\n                try {\n                    const saved = localStorage.getItem('babyCrySensitivity');\n                    if (saved) {\n                        this.sensitivity = parseInt(saved);\n                        document.getElementById('senderSensitivity').value = saved;\n                        document.getElementById('viewerSensitivity').value = saved;\n                        document.getElementById('senderSensitivityValue').textContent = saved;\n                        document.getElementById('viewerSensitivityValue').textContent = saved;\n                    }\n                } catch (e) {\n                    console.error('Failed to load sensitivity:', e);\n                }\n            },\n\n            // Update status indicator\n            updateStatus(state, text) {\n                this.connectionState = state;\n                const dot = document.getElementById('statusDot');\n                const statusText = document.getElementById('statusText');\n\n                dot.className = 'status-dot ' + state;\n                statusText.textContent = text;\n            },\n\n            // Show alert message\n            showAlert(message, type) {\n                const container = document.getElementById('alertContainer');\n                \n                const alert = document.createElement('div');\n                alert.className = `alert alert-${type} show`;\n                alert.textContent = message;\n                \n                container.innerHTML = '';\n                container.appendChild(alert);\n\n                // Auto-hide after 5 seconds for success/info\n                if (type === 'success' || type === 'info') {\n                    setTimeout(() => {\n                        alert.classList.remove('show');\n                        setTimeout(() => alert.remove(), 300);\n                    }, 5000);\n                }\n            },\n\n            // Update UI based on current mode\n            updateUI() {\n                // Update mode buttons\n                document.getElementById('senderModeBtn').classList.toggle('active', this.mode === 'sender');\n                document.getElementById('viewerModeBtn').classList.toggle('active', this.mode === 'viewer');\n\n                // Show/hide screens\n                document.getElementById('idleScreen').classList.toggle('hidden', this.mode !== 'idle');\n                document.getElementById('senderScreen').classList.toggle('hidden', this.mode !== 'sender');\n                document.getElementById('viewerScreen').classList.toggle('hidden', this.mode !== 'viewer');\n\n                // Disable mode switching while connected\n                const isConnected = this.connectionState === 'connected' || this.connectionState === 'connecting';\n                document.getElementById('senderModeBtn').disabled = isConnected && this.mode !== 'sender';\n                document.getElementById('viewerModeBtn').disabled = isConnected && this.mode !== 'viewer';\n            },\n\n            // Cleanup resources\n            cleanup() {\n                // Stop cry detection\n                this.cryDetectionActive = false;\n\n                // Close audio context\n                if (this.audioContext) {\n                    this.audioContext.close();\n                    this.audioContext = null;\n                }\n\n                this.analyser = null;\n\n                // Stop local stream\n                if (this.localStream) {\n                    this.localStream.getTracks().forEach(track => track.stop());\n                    this.localStream = null;\n                }\n\n                // Clear remote stream\n                if (this.remoteStream) {\n                    this.remoteStream.getTracks().forEach(track => track.stop());\n                    this.remoteStream = null;\n                }\n\n                // Close peer connection\n                if (this.peerConnection) {\n                    this.peerConnection.close();\n                    this.peerConnection = null;\n                }\n\n                // Reset UI\n                const localVideo = document.getElementById('localVideo');\n                const remoteVideo = document.getElementById('remoteVideo');\n                if (localVideo) localVideo.srcObject = null;\n                if (remoteVideo) remoteVideo.srcObject = null;\n\n                // Clear connection codes\n                document.getElementById('offerCode').textContent = 'Initializing...';\n                document.getElementById('answerCode').textContent = 'Waiting for offer...';\n                document.getElementById('offerInput').value = '';\n                document.getElementById('answerInput').value = '';\n                document.getElementById('copyAnswerBtn').disabled = true;\n\n                // Hide remote video container\n                document.getElementById('remoteVideoContainer').classList.add('hidden');\n                document.getElementById('viewerLoading').classList.remove('hidden');\n\n                // Reset status\n                this.updateStatus('idle', 'Idle');\n\n                // Clear alerts\n                document.getElementById('alertContainer').innerHTML = '';\n            }\n        };\n\n        // Initialize app when page loads\n        window.addEventListener('DOMContentLoaded', () => {\n            app.init();\n        });\n\n        // Cleanup on page unload\n        window.addEventListener('beforeunload', () => {\n            app.cleanup();\n        });\n    </script>\n</body>\n</html>\n"
  },
  "result": "OK: wrote 41248 bytes to baby-monitor.html",
  "tsIso": "2026-02-21T08:11:20.773Z"
}